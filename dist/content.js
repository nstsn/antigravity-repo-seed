class w{canHandle(e){return e.includes("chatgpt.com")||e.includes("chat.openai.com")}async getActiveThreadInfo(){if(!this.canHandle(window.location.href))return null;let e=document.title;return e.endsWith(" - ChatGPT")&&(e=e.substring(0,e.length-10)),{service:"chatgpt",title:e,url:window.location.href}}async renameActiveThread(e){try{const n=document.querySelector("nav");if(!n)throw new Error("Sidebar not found");const r=window.location.pathname,l=Array.from(n.querySelectorAll("a"));let c=l.find(t=>t.getAttribute("href")===r);if(c||(c=l.find(t=>t.getAttribute("aria-current")==="page")),!c)throw new Error("Active thread element not found");const s=c.closest("li")||c.parentElement;if(!s)throw new Error("Parent container not found");const d=Array.from(s.querySelectorAll("button")).find(t=>{const f=t.getAttribute("aria-label")||"";return/more|option|action/i.test(f)||t.querySelector("svg")});if(!d)return document.title=e,{success:!0,errorCode:"DOM_PARTIAL",hint:"Could not automate UI click. Tab title updated, search index saved."};d.click(),await new Promise(t=>setTimeout(t,200));const h=Array.from(document.querySelectorAll('[role="menuitem"], button')).find(t=>t.textContent?.includes("Rename")||t.textContent?.includes("名前を変更"));if(!h)throw new Error("Rename button not found in menu");h.click(),await new Promise(t=>setTimeout(t,200));const a=document.querySelector('input[type="text"]');if(a)return Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set?.call(a,e),a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})),a.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",code:"Enter",bubbles:!0})),{success:!0};throw new Error("Rename input field not found")}catch(n){return document.title=e+" - ChatGPT",{success:!0,errorCode:"DOM_FALLBACK",hint:`UI automation failed (${n.message}), but processed for extension Search/Index.`}}}}class b{canHandle(e){return e.includes("gemini.google.com")}async getActiveThreadInfo(){return this.canHandle(window.location.href)?{service:"gemini",title:document.title,url:window.location.href}:null}async renameActiveThread(e){try{return document.title=e,{success:!0,errorCode:"DOM_NOT_IMPLEMENTED",hint:"Gemini visual rename not supported yet, but saved to extension history."}}catch(n){return{success:!1,errorCode:"UNKNOWN",hint:n.message}}}}const p=[new w,new b];let i=null;function u(){const o=window.location.href;i=p.find(e=>e.canHandle(o))||null,console.log("Thread Renamer: Adapter detected:",i?"Yes":"No")}u();chrome.runtime.onMessage.addListener((o,e,n)=>{if(console.log("Thread Renamer: Message received",o),o.type==="GET_THREAD_INFO")return i||u(),i?(i.getActiveThreadInfo().then(r=>n(r)).catch(r=>{console.error(r),n(null)}),!0):(n(null),!1);if(o.type==="RENAME_THREAD")return i?(i.renameActiveThread(o.newTitle).then(r=>n(r)).catch(r=>n({success:!1,errorCode:"EXEC_ERROR",hint:r.message})),!0):n({success:!1,errorCode:"NO_ADAPTER"})});let m=window.location.href;const A=new MutationObserver(()=>{window.location.href!==m&&(m=window.location.href,console.log("Thread Renamer: URL changed"),u())});A.observe(document.body,{childList:!0,subtree:!0});
